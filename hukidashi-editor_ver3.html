<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .editor-container {
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    #editor {
      border: 1px solid #ccc;
      min-height: 300px;
      padding: 10px;
      background-color: #fff;
      overflow-wrap: break-word;
      word-break: break-word;
      overflow-x: auto;
      border-radius: 4px;
    }
    
    .toolbar {
      margin-bottom: 10px;
    }
    
    .toolbar button {
      margin: 0 4px;
      padding: 8px 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .toolbar button:hover {
      background-color: #0056b3;
    }
    
    .save-controls {
      margin-top: 12px;
    }

    /* é€šçŸ¥ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #saveMessage {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4caf50;
      color: #fff;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 1000;
    }

    #saveMessage.show {
      opacity: 1;
    }

    /* å…±é€š */
    .bubble {
      position: relative;
      display: inline-block;
      padding: 12px 16px;
      margin: 10px 0;
      font-size: 15px;
      line-height: 1.6;
      border-radius: 12px;
      clear: both;
      max-width: 90%;
      word-wrap: break-word;
    }

    /* Aã•ã‚“ï¼ˆå·¦å¯„ã›ï¼‰ */
    .bubble-a {
      background-color: #d0ebff;
      margin-right: auto;
      margin-left: 0;
    }

    .bubble-b {
      background-color: #f0f0f0;
      display: inline-block;
      text-align: left;
      border: 1px solid #ccc;
      margin-left: auto;
      margin-right: 0;
    }

    /* çŸ¢å°ã‚‚èª¿æ•´ */
    .bubble-a::before {
      content: "";
      position: absolute;
      top: 14px;
      left: -10px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-right: 10px solid #d0ebff;
    }

    .bubble-b::before {
      content: "";
      position: absolute;
      top: 14px;
      right: -10px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 10px solid #f0f0f0;
    }
    
    .bubble-wrapper {
      display: flex;
      margin: 10px 0;
    }
    
    .bubble-wrapper.left {
      justify-content: flex-start;
    }
    
    .bubble-wrapper.right {
      justify-content: flex-end;
    }
  </style>
</head>
<body>

<div class="page-wrapper">
  <div class="content-wrapper">
    <div class="main">
      <h1>ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸</h1>
      <div class="editor-container">
        <div class="toolbar">
          <button onclick="execCmd('bold')"><b>å¤ªå­—</b></button>
          <button onclick="execCmd('italic')"><i>æ–œä½“</i></button>
          <button onclick="execCmd('underline')"><u>ä¸‹ç·š</u></button>
          <button onclick="insertBubble('A')">ğŸ’¬ å¹ãå‡ºã—A</button>
          <button onclick="insertBubble('B')">ğŸ’¬ å¹ãå‡ºã—B</button>
          <button onclick="insertLineBreak()">ğŸ“ è¡ŒæŒ¿å…¥</button>
          <button onclick="removeFormatting()">ğŸ§¹ æ›¸å¼è§£é™¤</button>
        </div>

        <div id="editor" contenteditable="true">
          <p>ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ã‹ã‚‰å¹ãå‡ºã—ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€é¸æŠã—ãŸãƒ†ã‚­ã‚¹ãƒˆãŒå¹ãå‡ºã—ã«ãªã‚Šã¾ã™ã€‚</p>
        </div>

        <div class="save-controls">
          <button onclick="saveContent()">ğŸ’¾ ä¿å­˜</button>
          <button onclick="loadContent()">ğŸ“‚ èª­ã¿è¾¼ã¿</button>
          <button onclick="clearContent()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
        </div>
        <div id="saveMessage">ä¿å­˜ã—ã¾ã—ãŸ</div>
      </div>
    </div>
  </div>
</div>

<script>
  function execCmd(command) {
    document.execCommand(command, false, null);
  }

  function insertBubble(speaker) {
    const selection = window.getSelection();
    const editor = document.getElementById("editor");

    if (!selection || selection.rangeCount === 0) return;

    const range = selection.getRangeAt(0);

    // å¹ãå‡ºã—å†…ãªã‚‰å‡¦ç†ã—ãªã„
    const container = range.commonAncestorContainer;
    const bubbleAncestor = container.nodeType === 3 ? container.parentElement.closest(".bubble") : container.closest(".bubble");
    if (bubbleAncestor) return;

    if (!editor.contains(container)) return;

    const selectedText = selection.toString();
    if (!selectedText.trim()) return;

    const bubble = document.createElement("div");
    bubble.className = speaker === 'A' ? "bubble bubble-a" : "bubble bubble-b";
    bubble.innerHTML = `<span style="font-weight:bold;">${speaker}ã•ã‚“ï¼š</span><br>${selectedText}`;

    const wrapper = document.createElement("div");
    wrapper.className = `bubble-wrapper ${speaker === 'A' ? 'left' : 'right'}`;
    wrapper.appendChild(bubble);

    range.deleteContents();
    range.insertNode(wrapper);

    // ã‚«ãƒ¼ã‚½ãƒ«ã‚’å¹ãå‡ºã—ã®å¾Œã«ç§»å‹•
    const newRange = document.createRange();
    newRange.setStartAfter(wrapper);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);

    // æ”¹è¡Œã‚’è¿½åŠ 
    const br = document.createElement("br");
    newRange.insertNode(br);
    newRange.setStartAfter(br);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
  }

  function insertLineBreak() {
    const selection = window.getSelection();
    const editor = document.getElementById("editor");

    if (!selection || selection.rangeCount === 0) return;

    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer;
    
    // ç¾åœ¨ã®ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ãŒå¹ãå‡ºã—å†…ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
    const bubble = container.nodeType === 3
      ? container.parentElement.closest(".bubble")
      : container.closest(".bubble");

    if (bubble) {
      // å¹ãå‡ºã—å†…ã®å ´åˆã€ãã®å¹ãå‡ºã—ã®è¦ªwrapperè¦ç´ ã‚’è¦‹ã¤ã‘ã‚‹
      const bubbleWrapper = bubble.closest(".bubble-wrapper");
      if (bubbleWrapper) {
        // å¹ãå‡ºã—ã®å¾Œã«æ”¹è¡Œã‚’æŒ¿å…¥
        const br = document.createElement("br");
        bubbleWrapper.parentNode.insertBefore(br, bubbleWrapper.nextSibling);
        
        // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ–°ã—ã„æ”¹è¡Œã®å¾Œã«ç§»å‹•
        const newRange = document.createRange();
        newRange.setStartAfter(br);
        newRange.collapse(true);
        selection.removeAllRanges();
        selection.addRange(newRange);
      }
    } else {
      // å¹ãå‡ºã—å¤–ã®å ´åˆã¯é€šå¸¸ã®æ”¹è¡ŒæŒ¿å…¥
      const br = document.createElement("br");
      range.insertNode(br);
      
      // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ”¹è¡Œã®å¾Œã«ç§»å‹•
      const newRange = document.createRange();
      newRange.setStartAfter(br);
      newRange.collapse(true);
      selection.removeAllRanges();
      selection.addRange(newRange);
    }
  }

  function removeFormatting() {
    const selection = window.getSelection();
    const editor = document.getElementById("editor");

    if (!selection || selection.rangeCount === 0) {
      // é¸æŠãŒãªã„å ´åˆã¯å…¨ä½“ã®æ›¸å¼ã‚’è§£é™¤
      removeAllFormatting(editor);
      return;
    }

    const range = selection.getRangeAt(0);
    
    // é¸æŠç¯„å›²ãŒãªã„å ´åˆï¼ˆã‚«ãƒ¼ã‚½ãƒ«ã ã‘ã®å ´åˆï¼‰
    if (range.collapsed) {
      // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®è¦ç´ ã®æ›¸å¼ã‚’è§£é™¤
      const container = range.commonAncestorContainer;
      const element = container.nodeType === 3 ? container.parentElement : container;
      
      // å¹ãå‡ºã—å†…ã®å ´åˆã¯å¹ãå‡ºã—å…¨ä½“ã‚’è§£é™¤
      const bubble = element.closest('.bubble');
      if (bubble) {
        const bubbleWrapper = bubble.closest('.bubble-wrapper');
        if (bubbleWrapper) {
          const textContent = bubble.textContent || bubble.innerText;
          // "Aã•ã‚“ï¼š" ã‚„ "Bã•ã‚“ï¼š" ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
          const cleanText = textContent.replace(/^[AB]ã•ã‚“ï¼š/, '').trim();
          
          const textNode = document.createTextNode(cleanText + '\n');
          bubbleWrapper.parentNode.replaceChild(textNode, bubbleWrapper);
          
          // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆã®å¾Œã«è¨­å®š
          const newRange = document.createRange();
          newRange.setStartAfter(textNode);
          newRange.collapse(true);
          selection.removeAllRanges();
          selection.addRange(newRange);
        }
      } else {
        // é€šå¸¸ã®æ›¸å¼è§£é™¤
        document.execCommand('removeFormat', false, null);
      }
    } else {
      // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆ
      const selectedContent = range.extractContents();
      const cleanedContent = removeFormattingFromNode(selectedContent);
      range.insertNode(cleanedContent);
    }
  }

  function removeFormattingFromNode(node) {
    const fragment = document.createDocumentFragment();
    
    function processNode(currentNode) {
      if (currentNode.nodeType === 3) {
        // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã®å ´åˆã¯ãã®ã¾ã¾è¿½åŠ 
        fragment.appendChild(currentNode.cloneNode(true));
      } else if (currentNode.nodeType === 1) {
        // è¦ç´ ãƒãƒ¼ãƒ‰ã®å ´åˆ
        if (currentNode.classList && (currentNode.classList.contains('bubble') || currentNode.classList.contains('bubble-wrapper'))) {
          // å¹ãå‡ºã—ã®å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã®ã¿æŠ½å‡º
          const textContent = currentNode.textContent || currentNode.innerText;
          const cleanText = textContent.replace(/^[AB]ã•ã‚“ï¼š/, '').trim();
          if (cleanText) {
            const textNode = document.createTextNode(cleanText);
            fragment.appendChild(textNode);
            // æ”¹è¡Œã‚’è¿½åŠ 
            fragment.appendChild(document.createElement('br'));
          }
        } else {
          // ãã®ä»–ã®è¦ç´ ã¯å­ãƒãƒ¼ãƒ‰ã‚’å†å¸°çš„ã«å‡¦ç†
          const childNodes = Array.from(currentNode.childNodes);
          childNodes.forEach(child => processNode(child));
        }
      }
    }
    
    const childNodes = Array.from(node.childNodes);
    childNodes.forEach(child => processNode(child));
    
    return fragment;
  }

  function removeAllFormatting(container) {
    const content = container.innerHTML;
    
    // HTMLã‚¿ã‚°ã‚’é™¤å»ã—ã¦ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = content;
    
    // å¹ãå‡ºã—ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
    const bubbles = tempDiv.querySelectorAll('.bubble');
    bubbles.forEach(bubble => {
      const textContent = bubble.textContent || bubble.innerText;
      const cleanText = textContent.replace(/^[AB]ã•ã‚“ï¼š/, '').trim();
      const textNode = document.createTextNode(cleanText + '\n');
      bubble.parentNode.replaceChild(textNode, bubble.parentNode);
    });
    
    // æ®‹ã‚Šã®æ›¸å¼ã‚’è§£é™¤
    const plainText = tempDiv.textContent || tempDiv.innerText;
    container.innerHTML = '<p>' + plainText.replace(/\n/g, '<br>') + '</p>';
  }

  // å¹ãå‡ºã—å†…ã§ã®Enterã‚­ãƒ¼ã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ–
  document.getElementById("editor").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;

      const range = selection.getRangeAt(0);
      const container = range.commonAncestorContainer;

      // å¹ãå‡ºã—å†…ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
      const bubble = container.nodeType === 3
        ? container.parentElement.closest(".bubble")
        : container.closest(".bubble");

      // å¹ãå‡ºã—å†…ã®å ´åˆã¯Enterã‚­ãƒ¼ã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ–
      if (bubble) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }

      // å¹ãå‡ºã—ã®wrapperå…¨ä½“ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã‚‚ç„¡åŠ¹åŒ–
      const wrapper = container.nodeType === 3
        ? container.parentElement.closest(".bubble-wrapper")
        : container.closest(".bubble-wrapper");

      if (wrapper) {
        const isWholeWrapperSelected =
          range.startContainer === wrapper &&
          range.endContainer === wrapper &&
          range.startOffset === 0 &&
          range.endOffset === wrapper.childNodes.length;

        if (isWholeWrapperSelected) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      }
    }
  });

  function saveContent() {
    const content = document.getElementById("editor").innerHTML;
    try {
      localStorage.setItem("editorContent", content);
      console.log("ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ");
      showSaveMessage();
    } catch (error) {
      console.error("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
      alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  }

  function loadContent() {
    try {
      const saved = localStorage.getItem("editorContent");
      if (saved) {
        document.getElementById("editor").innerHTML = saved;
        console.log("ä¿å­˜ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
      } else {
        console.log("ä¿å­˜ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ã‚ã‚Šã¾ã›ã‚“");
      }
    } catch (error) {
      console.error("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
    }
  }

  function clearContent() {
    if (confirm("ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      document.getElementById("editor").innerHTML = "<p>ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ã‹ã‚‰å¹ãå‡ºã—ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€é¸æŠã—ãŸãƒ†ã‚­ã‚¹ãƒˆãŒå¹ãå‡ºã—ã«ãªã‚Šã¾ã™ã€‚</p>";
      try {
        localStorage.removeItem("editorContent");
        console.log("ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
      } catch (error) {
        console.error("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
      }
    }
  }

  function showSaveMessage() {
    const msg = document.getElementById("saveMessage");
    msg.classList.add("show");
    setTimeout(() => {
      msg.classList.remove("show");
    }, 2000);
  }

  window.addEventListener("DOMContentLoaded", () => {
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’èª­ã¿è¾¼ã‚€
    loadContent();
    console.log("ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ");
  });
</script>

</body>
</html>