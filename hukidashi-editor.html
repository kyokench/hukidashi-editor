<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸</title>
  <!-- ã‚¹ã‚¿ã‚¤ãƒ«ã¨å…±é€šã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <link rel="stylesheet" href="../style.css?20250630">
  <link rel="stylesheet" href="editor-style2.css">
  <script defer src="../sidebar.js"></script>
</head>
<body>

<div id="header-placeholder"></div>
<div class="page-wrapper">
  <aside id="sidebar">
    <!-- Sidebar content will be injected here by JS -->
  </aside>
  <div class="content-wrapper">
    <div class="main">
      <h1>ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸</h1>
      <div class="editor-container">
        <div class="toolbar">
          <button onclick="execCmd('bold')"><b>å¤ªå­—</b></button>
          <button onclick="execCmd('italic')"><i>æ–œä½“</i></button>
          <button onclick="execCmd('underline')"><u>ä¸‹ç·š</u></button>
          <button onclick="insertBubble('A')">ğŸ’¬ å¹ãå‡ºã—A</button>
          <button onclick="insertBubble('B')">ğŸ’¬ å¹ãå‡ºã—B</button>
        </div>

        <div id="editor" contenteditable="true">
        </div>

        <div class="save-controls">
          <button onclick="saveContent()">ğŸ’¾ ä¿å­˜</button>
        </div>
        <div id="saveMessage">ä¿å­˜ã—ã¾ã—ãŸ</div>
      </div>
    </div>
  </div>
</div>

<!-- é€šçŸ¥ã‚¨ãƒªã‚¢ -->


<script>

  function insertBubble(speaker) {
    const selection = window.getSelection();
    const editor = document.getElementById("editor");

    if (!selection || selection.rangeCount === 0) return;

    const range = selection.getRangeAt(0);

    // å¹ãå‡ºã—å†…ãªã‚‰å‡¦ç†ã—ãªã„ï¼ˆæ”¹è¡Œã ã‘ã«ãªã‚‹ï¼‰
    const container = range.commonAncestorContainer;
    const bubbleAncestor = container.nodeType === 3 ? container.parentElement.closest(".bubble") : container.closest(".bubble");
    if (bubbleAncestor) return;

    if (!editor.contains(container)) return;

    const selectedText = selection.toString();
    if (!selectedText.trim()) return;

    const bubble = document.createElement("div");
    bubble.className = speaker === 'A' ? "bubble bubble-a" : "bubble bubble-b";
    bubble.innerHTML = `<span style="font-weight:bold;">${speaker}ã•ã‚“ï¼š</span><br>${selectedText}`;

    const wrapper = document.createElement("div");
    wrapper.style.display = "flex";
    wrapper.style.justifyContent = speaker === 'A' ? "flex-start" : "flex-end";
    wrapper.appendChild(bubble);

    range.deleteContents();
    range.insertNode(wrapper);

    selection.removeAllRanges();
  }

document.getElementById("editor").addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer;

    // å¹ãå‡ºã—ã® wrapperï¼ˆflexï¼‰ã¨ bubble ã‚’å–å¾—
    const bubble = container.nodeType === 3
      ? container.parentElement.closest(".bubble")
      : container.closest(".bubble");

    const wrapper = bubble ? bubble.parentElement : null;

    // wrapper ãã®ã‚‚ã®ãŒå®Œå…¨é¸æŠã•ã‚Œã¦ã„ãŸå ´åˆã«Enterç„¡åŠ¹åŒ–
    if (wrapper && wrapper.contains(range.startContainer) && wrapper.contains(range.endContainer)) {
      const isWholeWrapperSelected =
        range.startContainer === wrapper &&
        range.endContainer === wrapper &&
        range.startOffset === 0 &&
        range.endOffset === wrapper.childNodes.length;

      if (isWholeWrapperSelected) {
        e.preventDefault(); // è¤‡è£½é˜²æ­¢
      }
    }
  }
});


  function saveContent() {
    const content = document.getElementById("editor").innerHTML;
    localStorage.setItem("editorContent", content);
    showSaveMessage();
  }

  function showSaveMessage() {
    const msg = document.getElementById("saveMessage");
    msg.classList.add("show");
    setTimeout(() => {
      msg.classList.remove("show");
    }, 2000); // 2ç§’å¾Œã«éè¡¨ç¤º
  }

  window.addEventListener("DOMContentLoaded", () => {
    const saved = localStorage.getItem("editorContent");
    if (saved) {
      document.getElementById("editor").innerHTML = saved;
    }
  });

</script>

<script src="../load_header.js"></script>
</body>
</html>
